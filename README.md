# disaster-recovery

**Disaster recovery**

First Hop Redundancy Protocol - Протокол резервирования первого перехода

**FHRP** — семейство сетевых протоколов, которые позволяют объединить группу физических маршрутизаторов в один логический с целью повышения отказоустойчивости локальной сети

Virtual Router Redundancy Protocol - Протокол резервирования виртуального маршрутизатора

**VRRP** — сетевой протокол, предназначенный для увеличения доступности маршрутизаторов, выполняющих роль шлюза по умолчанию. Реализует высокую доступность, создавая виртуальные маршрутизаторы. Если основной маршрутизатор выходит из строя VRRP позволяет переключиться на резервный маршрутизатор.

Виртуальный маршрутизатор назначается шлюзом по умолчанию для участвующих хостов вместо физического маршрутизатора.

**HSRP** — проприетарный протокол от компании Cisco Systems, прародитель протокола VRRP


**Плавающие IP** — дополнительный статический IP-адрес, с помощью которого можно получить доступ к серверу, к которому он в настоящее время прикреплён. Позволяют Быстро переназначить адрес на другой ресурс для увеличения доступности сервиса.

**Keepalived** — сервис для увеличения отказоустойчивости и балансировки нагрузки. Отказоустойчивость достигается при помощи протокола VRRP.

```
vrrp_instance VI_1
  state MASTE
  interface ens3
  virtual_router_id 1
  priority 25
  advert_int

  virtual_ipaddress {
    192.168.111.15/2
  }
}
```

**Кластеризация и балансировка нагрузки**

**Nginx** (engine x) — HTTP-сервер и обратный прокси-сервер, почтовый прокси-сервер, а также TCP/UDP-прокси-сервер общего назначения

Config
```
http { # контекст (блочная директива)
  server {
    listen 8000; # простая директива
  location / {
    return 200 'Hello world!';
  }
  }
}
```

- Установим Nginx, проверим конфиг, запустим демон.
- Поднимем два простых сервера на Python, которые будут возвращать разный файл в зависимости от того, на каком порту запущен сервер (simple http server python)
- Узнаем про nginx.conf и про конфиг default.conf
- Покажем, как создать upstream
- Посмотрим результаты через curl
- Затем поменяем вес первого на 5 и проверим: на первый сервер придёт 5 запросов, потом один на второй
- Через секцию stream попробуем настроить TCP-балансировку

**HAProxy** — высокопроизводительный балансировщик нагрузки с открытым исходным кодом и обратный прокси-  сервер для балансировки TCP- и HTTP-трафика

Config
```
listen stats # веб-страница со статистикой 
  bind :888 
  mode http 
  stats enable 
  stats uri /stats 
  stats refresh 5s 
  stats realm Haproxy\ Statistics

frontend example # секция фронтенд 
  mode http 
  bind :8088 
  default_backend web_servers

backend web_servers # секция бэкенд 
  mode http 
  balance roundrobin 
  option httpchk 
  http-check send meth GET uri /index.html 
  server s1 127.0.0.1:8888 check 
  server s2 127.0.0.1:9999 check
```
- Поставим HAProxy
- Посмотрим конфиг
- Посмотрим балансировку по определённому хосту, чтобы при запросе этого хоста было перенаправление на определённый бэкенд
- Различные варианты чеков — HTTP- (с запросом страницы) и TCP-чек
- Увидим в логах сервера при HTTP-чеках, что запросы идут каждую секунду, проверяя жив ли сервер
- Проверим конфиг через
```
haproxy -f /path/to/haproxy.cfg –c
```
- Проверим TCP- и HTTP-балансировку, в случае с TCP-балансировкой указывать хост в заголовках curl необязательно
- Рассмотрим цепочку nginx -> haproxy
- Такая связка полезна, так как HAProxy может проверять здоровье серверов, а Nginx нет
